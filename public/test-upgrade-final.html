<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Upgrade PRO</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .warning { border-color: #ff9800; background-color: #fff3e0; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #4CAF50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #ff9800; color: white; }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .result-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Teste Final - Upgrade PRO</h1>
        <p>Esta p√°gina testa o upgrade para o plano PRO diretamente no navegador.</p>
        
        <div class="info-box">
            <h3>üìã Informa√ß√µes do Teste</h3>
            <ul>
                <li><strong>User ID:</strong> 9ba39a20-7409-479d-a010-284ad452d4f8</li>
                <li><strong>Email:</strong> eduspires123@gmail.com</li>
                <li><strong>Plano:</strong> PRO (R$ 39,90/m√™s)</li>
                <li><strong>Servidor:</strong> <span id="server-status">Verificando...</span></li>
            </ul>
        </div>

        <!-- Teste 1: Health Check -->
        <div class="test-section" id="health-section">
            <h3>1Ô∏è‚É£ Health Check</h3>
            <p>Verificando se o servidor est√° funcionando...</p>
            <button onclick="testHealth()" id="health-btn">Testar Health API</button>
            <div id="health-result"></div>
        </div>

        <!-- Teste 2: Upgrade PRO -->
        <div class="test-section" id="upgrade-section">
            <h3>2Ô∏è‚É£ Upgrade PRO</h3>
            <p>Testando o upgrade para o plano PRO...</p>
            <button onclick="testUpgrade()" id="upgrade-btn">Testar Upgrade PRO</button>
            <div id="upgrade-result"></div>
        </div>

        <!-- Teste 3: Acesso direto ao pricing -->
        <div class="test-section" id="pricing-section">
            <h3>3Ô∏è‚É£ P√°gina de Pricing</h3>
            <p>Acesso direto √† p√°gina de pricing para teste manual...</p>
            <button onclick="openPricing()">Abrir P√°gina de Pricing</button>
            <button onclick="openDashboard()">Abrir Dashboard</button>
        </div>

        <!-- Log de resultados -->
        <div class="test-section">
            <h3>üìù Log de Resultados</h3>
            <div class="log" id="log"></div>
            <button onclick="clearLog()">Limpar Log</button>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${message}\n`;
            logElement.textContent += logLine;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            logElement.textContent = '';
        }

        function setStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="status ${status}">${status.toUpperCase()}</span> ${message}`;
            
            const section = element.closest('.test-section');
            section.className = `test-section ${status}`;
        }

        async function testHealth() {
            log('üîç Iniciando teste de Health API...');
            document.getElementById('health-btn').disabled = true;
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                log(`‚úÖ Health API respondeu com status ${response.status}`);
                log(`üìä Resposta: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok) {
                    setStatus('health-result', 'success', 'API Health funcionando corretamente');
                    
                    // Verificar vari√°veis do MercadoPago
                    if (data.checks && data.checks.environmentVariables) {
                        const envVars = data.checks.environmentVariables.details;
                        const mercadoOk = envVars.MERCADOPAGO_ACCESS_TOKEN && envVars.NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY;
                        
                        if (mercadoOk) {
                            log('‚úÖ Vari√°veis do MercadoPago: OK');
                        } else {
                            log('‚ö†Ô∏è Vari√°veis do MercadoPago: Faltando');
                        }
                    }
                } else {
                    setStatus('health-result', 'error', `Erro ${response.status}: ${data.error || 'Erro desconhecido'}`);
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de Health: ${error.message}`);
                setStatus('health-result', 'error', `Erro de conex√£o: ${error.message}`);
            }
            
            document.getElementById('health-btn').disabled = false;
        }

        async function testUpgrade() {
            log('üöÄ Iniciando teste de Upgrade PRO...');
            document.getElementById('upgrade-btn').disabled = true;
            
            const requestData = {
                planId: 'PRO',
                userId: '9ba39a20-7409-479d-a010-284ad452d4f8',
                userEmail: 'eduspires123@gmail.com',
                userName: 'eduspires'
            };
            
            log(`üì§ Enviando dados: ${JSON.stringify(requestData, null, 2)}`);
            
            try {
                const response = await fetch('/api/subscriptions/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                log(`üì• Resposta recebida com status ${response.status}`);
                log(`üìä Dados: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok && data.success) {
                    setStatus('upgrade-result', 'success', `Upgrade bem-sucedido! Tipo: ${data.type}`);
                    
                    if (data.type === 'payment' && data.checkoutUrl) {
                        log('üí≥ URL de checkout gerada com sucesso!');
                        log(`üîó URL: ${data.checkoutUrl}`);
                        
                        // Criar bot√£o para abrir checkout
                        const checkoutBtn = document.createElement('button');
                        checkoutBtn.textContent = 'Abrir Checkout MercadoPago';
                        checkoutBtn.onclick = () => window.open(data.checkoutUrl, '_blank');
                        document.getElementById('upgrade-result').appendChild(checkoutBtn);
                    }
                } else {
                    setStatus('upgrade-result', 'error', `Erro: ${data.error || 'Erro desconhecido'}`);
                    
                    if (response.status === 503) {
                        log('üîß Erro 503: Servi√ßo de pagamento temporariamente indispon√≠vel');
                        log('üí° Isso indica problema na integra√ß√£o MercadoPago');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de Upgrade: ${error.message}`);
                setStatus('upgrade-result', 'error', `Erro de conex√£o: ${error.message}`);
            }
            
            document.getElementById('upgrade-btn').disabled = false;
        }

        function openPricing() {
            log('üîó Abrindo p√°gina de Pricing...');
            window.open('/pricing', '_blank');
        }

        function openDashboard() {
            log('üîó Abrindo Dashboard...');
            window.open('/dashboard', '_blank');
        }

        // Verificar status do servidor ao carregar
        window.onload = async function() {
            log('üåê P√°gina carregada, verificando servidor...');
            
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    document.getElementById('server-status').innerHTML = '<span class="status success">ONLINE</span>';
                    log('‚úÖ Servidor Next.js est√° online');
                } else {
                    document.getElementById('server-status').innerHTML = '<span class="status error">ERRO</span>';
                    log('‚ùå Servidor respondeu com erro');
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = '<span class="status error">OFFLINE</span>';
                log('‚ùå Servidor parece estar offline');
            }
        };
    </script>
</body>
</html> 